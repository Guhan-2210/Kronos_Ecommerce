name: Smart CI/CD Pipeline

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - deploy-preview
          - deploy-production
          - rollback
      worker:
        description: 'Worker name (e.g., auth-worker, cart-worker)'
        required: true
        type: string
      deployment_id:
        description: 'Deployment Version ID (for rollback only)'
        required: false
        type: string

# Grant permissions for GitHub token
permissions:
  contents: read
  pull-requests: write
  issues: write

env:
  NODE_VERSION: 20
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

jobs:
  # ========================================
  # DETECT CHANGED WORKERS
  # ========================================
  detect-changes:
    name: Detect Changed Workers
    runs-on: ubuntu-latest
    outputs:
      workers: ${{ steps.detect.outputs.workers }}
      matrix: ${{ steps.detect.outputs.matrix }}
      has_changes: ${{ steps.detect.outputs.has_changes }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for accurate diff

      - name: Detect changed workers
        id: detect
        run: |
          # Define all workers (excludes log-consolidator - cron-only, no tests)
          ALL_WORKERS=(
            "auth-worker"
            "cart-worker"
            "catalog-worker"
            "fulfilment-worker"
            "order-worker"
            "payment-worker"
            "price-worker"
          )

          # Initialize empty array
          CHANGED_WORKERS=()

          # For PRs, compare against target branch
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_REF="${{ github.event.pull_request.base.sha }}"
            HEAD_REF="${{ github.event.pull_request.head.sha }}"
          # For pushes to main, compare with previous commit
          elif [ "${{ github.event_name }}" == "push" ]; then
            BASE_REF="${{ github.event.before }}"
            HEAD_REF="${{ github.sha }}"
          # For manual dispatch, use input
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "workers=[\"${{ github.event.inputs.worker }}\"]" >> $GITHUB_OUTPUT
            echo "matrix={\"worker\":[\"${{ github.event.inputs.worker }}\"]}" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Comparing $BASE_REF...$HEAD_REF"

          # Get changed files
          CHANGED_FILES=$(git diff --name-only $BASE_REF $HEAD_REF || echo "")

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Check each worker for changes
          for worker in "${ALL_WORKERS[@]}"; do
            if echo "$CHANGED_FILES" | grep -q "^${worker}/src/"; then
              echo "‚úÖ Detected changes in: $worker"
              CHANGED_WORKERS+=("$worker")
            fi
          done

          # Convert to JSON array
          if [ ${#CHANGED_WORKERS[@]} -eq 0 ]; then
            echo "workers=[]" >> $GITHUB_OUTPUT
            echo "matrix={}" >> $GITHUB_OUTPUT
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  No worker source changes detected"
          else
            # Build JSON array manually for reliability
            WORKERS_JSON="["
            for i in "${!CHANGED_WORKERS[@]}"; do
              if [ $i -gt 0 ]; then
                WORKERS_JSON+=","
              fi
              WORKERS_JSON+="\"${CHANGED_WORKERS[$i]}\""
            done
            WORKERS_JSON+="]"
            
            echo "workers=$WORKERS_JSON" >> $GITHUB_OUTPUT
            echo "matrix={\"worker\":$WORKERS_JSON}" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "üì¶ Changed workers: ${CHANGED_WORKERS[*]}"
          fi

  # ========================================
  # RUN CI (Lint, Format, Knip, Tests)
  # ========================================
  ci:
    name: CI - ${{ matrix.worker }}
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            ${{ matrix.worker }}/package-lock.json

      - name: Install root dependencies for lint/prettier
        run: npm ci

      - name: Run ESLint on worker
        run: |
          echo "üîç Running ESLint on ${{ matrix.worker }}..."
          npx eslint "${{ matrix.worker }}/**/*.js" || echo "‚ö†Ô∏è ESLint found issues (non-blocking)"

      - name: Run Prettier Check on worker
        run: |
          echo "üé® Running Prettier check on ${{ matrix.worker }}..."
          npx prettier --check "${{ matrix.worker }}/**/*.{js,json}" || echo "‚ö†Ô∏è Prettier found formatting issues (non-blocking)"

      - name: Install worker dependencies
        working-directory: ${{ matrix.worker }}
        run: npm ci

      - name: Run tests with coverage
        working-directory: ${{ matrix.worker }}
        run: npm run test:coverage || true

      - name: Check coverage threshold
        working-directory: ${{ matrix.worker }}
        run: |
          if [ -f "coverage/coverage-summary.json" ]; then
            COVERAGE=$(node -pe "JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json', 'utf8')).total.lines.pct")
            echo "üìä Code coverage: ${COVERAGE}%"
            
            if (( $(echo "$COVERAGE < 50" | bc -l) )); then
              echo "‚ùå Coverage ${COVERAGE}% is below 50% threshold"
              exit 1
            else
              echo "‚úÖ Coverage ${COVERAGE}% meets threshold"
            fi
          else
            echo "‚ö†Ô∏è No coverage report found, skipping check"
          fi

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-${{ matrix.worker }}
          path: ${{ matrix.worker }}/coverage/
          retention-days: 7

  # ========================================
  # DEPLOY TO PREVIEW (PR only)
  # ========================================
  deploy-preview:
    name: Deploy Preview - ${{ matrix.worker }}
    runs-on: ubuntu-latest
    needs: [detect-changes, ci]
    if: |
      needs.detect-changes.outputs.has_changes == 'true' &&
      (github.event_name == 'pull_request' || 
       (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'deploy-preview'))
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install worker dependencies
        working-directory: ${{ matrix.worker }}
        run: npm ci

      - name: Get Previous Deployment Version
        id: prev_version
        working-directory: ${{ matrix.worker }}
        run: |
          echo "Getting previous deployment version..."
          PREV_VERSION=$(npx wrangler deployments list --env preview 2>/dev/null | grep -v "Version ID" | head -1 | awk '{print $1}' || echo "none")
          echo "previous_version=$PREV_VERSION" >> $GITHUB_OUTPUT
          echo "Previous version: $PREV_VERSION"

      - name: Deploy to Cloudflare Preview
        id: deploy
        working-directory: ${{ matrix.worker }}
        run: |
          echo "üöÄ Deploying ${{ matrix.worker }} to preview..."
          npx wrangler deploy --env preview

      - name: Wait for deployment propagation
        run: |
          echo "‚è≥ Waiting 30 seconds for deployment to propagate..."
          sleep 30

      - name: Health Check
        id: health_check
        run: |
          WORKER_NAME="${{ matrix.worker }}"
          HEALTH_URL="https://${WORKER_NAME}-preview.guhan2210.workers.dev/health"

          echo "üè• Running health check on $HEALTH_URL"

          MAX_RETRIES=5
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")
            echo "Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES: Status $HEALTH_STATUS"
            
            if [ "$HEALTH_STATUS" = "200" ]; then
              echo "‚úÖ Health check passed!"
              echo "status=success" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "‚è≥ Retrying in 10 seconds..."
              sleep 10
            fi
          done

          echo "‚ùå Health check failed after $MAX_RETRIES attempts"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1

      - name: Notify Slack - Preview Deployment Success
        if: success() && steps.health_check.outputs.status == 'success'
        run: |
          curl -X POST ${{ env.SLACK_WEBHOOK_URL }} \
          -H 'Content-Type: application/json' \
          -d '{
            "text": "‚úÖ Preview Deployment Successful - ${{ matrix.worker }}",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "‚úÖ Preview Deployment Successful"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Worker:*\n`${{ matrix.worker }}`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Environment:*\nüü° Preview"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Branch:*\n`${{ github.head_ref || github.ref_name }}`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Health Check:*\n‚úÖ Passed"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Preview URL:* https://${{ matrix.worker }}-preview.guhan2210.workers.dev"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Run> ‚Ä¢ <${{ github.event.pull_request.html_url || github.event.head_commit.url }}|View PR/Commit>"
                }
              }
            ]
          }'

      - name: Rollback on Health Check Failure
        if: failure() && steps.health_check.outcome == 'failure' && steps.prev_version.outputs.previous_version != 'none'
        working-directory: ${{ matrix.worker }}
        run: |
          echo "üîÑ Health check failed! Rolling back to previous version..."
          echo "Previous version: ${{ steps.prev_version.outputs.previous_version }}"
          npx wrangler versions deploy ${{ steps.prev_version.outputs.previous_version }}@100% --env preview --yes
          echo "‚úÖ Rollback completed!"

      - name: Notify Slack - Preview Deployment Failed & Rolled Back
        if: failure() && steps.health_check.outcome == 'failure'
        run: |
          curl -X POST ${{ env.SLACK_WEBHOOK_URL }} \
          -H 'Content-Type: application/json' \
          -d '{
            "text": "üö® Preview Deployment Failed - ${{ matrix.worker }}",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "üö® Preview Deployment Failed"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Worker:*\n`${{ matrix.worker }}`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Environment:*\nüü° Preview"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Branch:*\n`${{ github.head_ref || github.ref_name }}`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Status:*\n‚ùå Health check failed"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Action Taken:* ${{ steps.prev_version.outputs.previous_version != 'none' && 'Automatically rolled back to previous version' || 'No previous version available for rollback' }}"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Run> ‚Ä¢ <${{ github.event.pull_request.html_url || github.event.head_commit.url }}|View PR/Commit>"
                }
              }
            ]
          }'

      - name: Comment PR with deployment status
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const worker = '${{ matrix.worker }}';
            const status = '${{ steps.health_check.outputs.status }}';
            const url = `https://${worker}-preview.guhan2210.workers.dev/health`;

            let emoji = status === 'success' ? '‚úÖ' : '‚ùå';
            let message = status === 'success' ? 'Deployed successfully!' : 'Health check failed - rolled back';

            const comment = `### ${emoji} Preview Deployment: \`${worker}\`

            **Status:** ${message}
            **Environment:** Preview
            **Health Check:** ${url}

            ${status === 'success' ? 'üéâ Ready for testing!' : '‚ö†Ô∏è Deployment failed and was rolled back'}`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # ========================================
  # DEPLOY TO PRODUCTION (main push only)
  # ========================================
  deploy-production:
    name: Deploy Production - ${{ matrix.worker }}
    runs-on: ubuntu-latest
    needs: [detect-changes, ci]
    if: |
      needs.detect-changes.outputs.has_changes == 'true' &&
      (github.event_name == 'push' && github.ref == 'refs/heads/main' ||
       (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'deploy-production'))
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install worker dependencies
        working-directory: ${{ matrix.worker }}
        run: npm ci

      - name: Get Previous Deployment Version
        id: prev_version
        working-directory: ${{ matrix.worker }}
        run: |
          echo "Getting previous production deployment version..."
          PREV_VERSION=$(npx wrangler deployments list --env production 2>/dev/null | grep -v "Version ID" | head -1 | awk '{print $1}' || echo "none")
          echo "previous_version=$PREV_VERSION" >> $GITHUB_OUTPUT
          echo "Previous version: $PREV_VERSION"

      - name: Deploy to Cloudflare Production
        id: deploy
        working-directory: ${{ matrix.worker }}
        run: |
          echo "üöÄ Deploying ${{ matrix.worker }} to production..."
          npx wrangler deploy --env production

      - name: Wait for deployment propagation
        run: |
          echo "‚è≥ Waiting 30 seconds for deployment to propagate..."
          sleep 30

      - name: Health Check
        id: health_check
        run: |
          WORKER_NAME="${{ matrix.worker }}"
          # Map worker names to their production URLs
          case $WORKER_NAME in
            "auth-worker")
              HEALTH_URL="https://ecommerce-auth.guhan2210.workers.dev/health"
              ;;
            *)
              HEALTH_URL="https://${WORKER_NAME}.guhan2210.workers.dev/health"
              ;;
          esac

          echo "üè• Running health check on $HEALTH_URL"

          MAX_RETRIES=5
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")
            echo "Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES: Status $HEALTH_STATUS"
            
            if [ "$HEALTH_STATUS" = "200" ]; then
              echo "‚úÖ Health check passed!"
              echo "status=success" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "‚è≥ Retrying in 10 seconds..."
              sleep 10
            fi
          done

          echo "‚ùå Health check failed after $MAX_RETRIES attempts"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1

      - name: Get PR Information
        id: pr_info
        if: success()
        run: |
          # Try to get PR number and title from the merge commit
          PR_NUMBER=$(git log -1 --pretty=%B | grep -oP '#\K[0-9]+' | head -1 || echo "N/A")
          PR_TITLE=$(git log -1 --pretty=%s || echo "Direct push to main")
          COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an' || echo "${{ github.actor }}")
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
          echo "commit_author=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT

      - name: Notify Slack - Production Deployment Success
        if: success() && steps.health_check.outputs.status == 'success'
        run: |
          curl -X POST ${{ env.SLACK_WEBHOOK_URL }} \
          -H 'Content-Type: application/json' \
          -d '{
            "text": "‚úÖ Production Deployment Successful - ${{ matrix.worker }}",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "‚úÖ Production Deployment Successful - PR Merged"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Worker:*\n`${{ matrix.worker }}`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Environment:*\nüî¥ Production"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Branch:*\n`main`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Health Check:*\n‚úÖ Passed"
                  }
                ]
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*PR Number:*\n#${{ steps.pr_info.outputs.pr_number }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Merged by:*\n${{ github.actor }}"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Commit:*\n```${{ steps.pr_info.outputs.pr_title }}```"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Run> ‚Ä¢ <${{ github.event.head_commit.url }}|View Commit>"
                }
              }
            ]
          }'

      - name: Rollback on Health Check Failure
        if: failure() && steps.health_check.outcome == 'failure' && steps.prev_version.outputs.previous_version != 'none'
        working-directory: ${{ matrix.worker }}
        run: |
          echo "üîÑ Health check failed! Rolling back to previous version..."
          echo "Previous version: ${{ steps.prev_version.outputs.previous_version }}"
          npx wrangler versions deploy ${{ steps.prev_version.outputs.previous_version }}@100% --env production --yes
          echo "‚úÖ Rollback completed!"

      - name: Notify Slack - Production Deployment Failed & Rolled Back
        if: failure() && steps.health_check.outcome == 'failure'
        run: |
          curl -X POST ${{ env.SLACK_WEBHOOK_URL }} \
          -H 'Content-Type: application/json' \
          -d '{
            "text": "üö® Production Deployment Failed - ${{ matrix.worker }}",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "üö® Production Deployment Failed - Rollback Executed"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Worker:*\n`${{ matrix.worker }}`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Environment:*\nüî¥ Production"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Branch:*\n`main`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Status:*\n‚ùå Health check failed"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Action Taken:* ${{ steps.prev_version.outputs.previous_version != 'none' && 'Automatically rolled back to previous version' || 'No previous version available for rollback' }}"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "‚ö†Ô∏è *URGENT:* Production deployment failed and was rolled back. Immediate investigation required!"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Run> ‚Ä¢ <${{ github.event.head_commit.url }}|View Commit>"
                }
              }
            ]
          }'

      - name: Create deployment summary
        if: always()
        run: |
          echo "## üöÄ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Worker:** ${{ matrix.worker }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.health_check.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.health_check.outputs.status }}" = "failed" ]; then
            echo "**Action:** Automatically rolled back to previous version" >> $GITHUB_STEP_SUMMARY
          fi

  # ========================================
  # MANUAL ROLLBACK
  # ========================================
  manual-rollback:
    name: Manual Rollback - ${{ github.event.inputs.worker }}
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'rollback'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install worker dependencies
        working-directory: ${{ github.event.inputs.worker }}
        run: npm ci

      - name: Determine environment from worker name
        id: env
        run: |
          WORKER_NAME="${{ github.event.inputs.worker }}"
          if [[ "$WORKER_NAME" == *"-preview" ]]; then
            echo "environment=preview" >> $GITHUB_OUTPUT
          else
            echo "environment=production" >> $GITHUB_OUTPUT
          fi

      - name: List Recent Deployments
        working-directory: ${{ github.event.inputs.worker }}
        run: |
          echo "üìã Recent deployments for ${{ github.event.inputs.worker }} (${{ steps.env.outputs.environment }}):"
          npx wrangler deployments list --env ${{ steps.env.outputs.environment }} || echo "Unable to list deployments"

      - name: Rollback to Specific Version
        working-directory: ${{ github.event.inputs.worker }}
        run: |
          echo "üîÑ Rolling back ${{ github.event.inputs.worker }} to deployment version:"
          echo "üì¶ Deployment ID: ${{ github.event.inputs.deployment_id }}"
          if [ -n "${{ github.event.inputs.deployment_id }}" ]; then
            echo "Deploying specific version: ${{ github.event.inputs.deployment_id }}"
            npx wrangler versions deploy ${{ github.event.inputs.deployment_id }}@100% --env ${{ steps.env.outputs.environment }} --yes
          else
            echo "No version ID provided, getting previous version..."
            PREV_VERSION=$(npx wrangler deployments list --env ${{ steps.env.outputs.environment }} 2>/dev/null | grep -v "Version ID" | head -1 | awk '{print $1}')
            if [ -n "$PREV_VERSION" ]; then
              echo "Rolling back to previous version: $PREV_VERSION"
              npx wrangler versions deploy ${PREV_VERSION}@100% --env ${{ steps.env.outputs.environment }} --yes
            else
              echo "‚ùå No previous version found to rollback to"
              exit 1
            fi
          fi
          echo "‚úÖ Rollback completed successfully!"

      - name: Notify Slack - Manual Rollback Success
        if: success()
        run: |
          curl -X POST ${{ env.SLACK_WEBHOOK_URL }} \
          -H 'Content-Type: application/json' \
          -d '{
            "text": "‚úÖ Manual Rollback Successful - ${{ github.event.inputs.worker }}",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "‚úÖ Manual Rollback Successful"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Worker:*\n`${{ github.event.inputs.worker }}`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Environment:*\n${{ steps.env.outputs.environment == 'production' && 'üî¥ Production' || 'üü° Preview' }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Rolled back to:*\n`${{ github.event.inputs.deployment_id }}`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Initiated by:*\n${{ github.actor }}"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Run>"
                }
              }
            ]
          }'

      - name: Notify Slack - Manual Rollback Failed
        if: failure()
        run: |
          curl -X POST ${{ env.SLACK_WEBHOOK_URL }} \
          -H 'Content-Type: application/json' \
          -d '{
            "text": "‚ùå Manual Rollback Failed - ${{ github.event.inputs.worker }}",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "‚ùå Manual Rollback Failed"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Worker:*\n`${{ github.event.inputs.worker }}`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Environment:*\n${{ steps.env.outputs.environment == 'production' && 'üî¥ Production' || 'üü° Preview' }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Target Version:*\n`${{ github.event.inputs.deployment_id }}`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Initiated by:*\n${{ github.actor }}"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "‚ö†Ô∏è *URGENT:* Manual rollback failed. Immediate investigation required!"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Run>"
                }
              }
            ]
          }'

      - name: Create rollback summary
        run: |
          echo "## üîÑ Manual Rollback Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Worker:** ${{ github.event.inputs.worker }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ steps.env.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Rolled back to:** ${{ github.event.inputs.deployment_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
